name: "Tauri Release Build"

on:
  push:
    tags:
      - 'v*' # æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v0.2.1)'
        required: true
        default: 'v0.2.1'

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-latest]

    runs-on: ${{ matrix.platform }}
    steps:
      - name: "1. æ£€æŸ¥ä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "2. æ¸…é™¤ç¼“å­˜"
        run: |
          # æ¸…é™¤å¯èƒ½çš„ç¼“å­˜
          rm -rf ~/.cargo/registry
          rm -rf ~/.cargo/git
          rm -rf node_modules
          rm -rf src-tauri/target

      - name: "3. å®‰è£… Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: "4. å®‰è£… Rust å·¥å…·é“¾"
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-unknown-linux-gnu

      - name: "5. å®‰è£… Linux æ„å»ºä¾èµ–"
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            rpm \
            patchelf

      - name: "6. éªŒè¯ç‰ˆæœ¬å·"
        run: |
          echo "=== éªŒè¯ç‰ˆæœ¬å· ==="
          echo "package.json: $(node -p \"require('./package.json').version\")"
          echo "Cargo.toml: $(grep '^version =' src-tauri/Cargo.toml)"
          echo "tauri.conf.json: $(grep -o '\"version\":\"[^\"]*\"' src-tauri/tauri.conf.json)"
          echo "Gitæ ‡ç­¾: ${{ github.ref_name }}"

      - name: "7. å®‰è£…é¡¹ç›®ä¾èµ–"
        run: |
          npm ci --no-audit
          cd src-tauri && cargo fetch

      - name: "8. æ„å»ºå‰ç«¯"
        run: npm run build

      - name: "9. æ‰§è¡Œ Tauri æ„å»º"
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name || inputs.version }}
          releaseName: "Easy Proton ${{ github.ref_name || inputs.version }}"
          releaseBody: |
            ## ğŸ® Easy Proton ${{ github.ref_name || inputs.version }}

            ### ä¸‹è½½
            - **.deb**: Debian/Ubuntu ç”¨æˆ·
            - **.rpm**: Fedora/RHEL ç”¨æˆ·
            - **.AppImage**: é€šç”¨Linuxå‘è¡Œç‰ˆ

            ### å®‰è£…è¯´æ˜
            1. ä¸‹è½½å¯¹åº”çš„å®‰è£…åŒ…
            2. åŒå‡»å®‰è£…æˆ–ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…
            3. è¿è¡Œ Easy Proton

            ### æ³¨æ„äº‹é¡¹
            - éœ€è¦å·²å®‰è£… Proton ç¯å¢ƒ
            - é¦–æ¬¡ä½¿ç”¨è¯·è®¾ç½® Proton è·¯å¾„
          releaseDraft: true
          prerelease: false
          includeUpdaterJson: false
          includeReleaseNotes: true

      - name: "10. éªŒè¯æ„å»ºäº§ç‰©ç‰ˆæœ¬"
        run: |
          echo "=== éªŒè¯æ„å»ºäº§ç‰© ==="
          if [ -f src-tauri/target/release/bundle/rpm/*.rpm ]; then
            rpm -qip src-tauri/target/release/bundle/rpm/*.rpm | grep -E "Version|Release"
          fi
          if [ -f src-tauri/target/release/bundle/deb/*.deb ]; then
            dpkg-deb -I src-tauri/target/release/bundle/deb/*.deb | grep Version
          fi

      - name: "11. ä¸Šä¼ æ„å»ºäº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: easy-proton-build-${{ github.ref_name || inputs.version }}
          path: |
            src-tauri/target/release/bundle/**/*.deb
            src-tauri/target/release/bundle/**/*.rpm
            src-tauri/target/release/bundle/**/*.AppImage
          retention-days: 7

  notify:
    needs: publish-tauri
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: "æ„å»ºæˆåŠŸé€šçŸ¥"
        run: |
          echo "ğŸ‰ Easy Proton ${{ github.ref_name || inputs.version }} æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“¦ å‘å¸ƒåŒ…å·²ä¸Šä¼ åˆ° GitHub Releases"
          echo "ğŸ”— å‰å¾€ https://github.com/${{ github.repository }}/releases æŸ¥çœ‹"

